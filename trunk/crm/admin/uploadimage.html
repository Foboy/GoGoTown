<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Jcrop &raquo; Tutorials &raquo; aspectRatio w/ Preview</title>
    <link href="css/plugins/jcrop/jquery.Jcrop.css" rel="stylesheet" />
    <link href="css/plugins/uploadify/uploadify.css" rel="stylesheet" />
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/plugins/jcrop/jquery.Jcrop.js" type="text/javascript"></script>
    <script src="js/plugins/uploadify/jquery.uploadify.js" type="text/javascript"></script>
    <style type="text/css">
        table {
            border-spacing: 20px;
        }
    </style>

    <script type="text/javascript">
        //配置裁剪插件Jcrop
        function userJcrop() {
            var boundx, boundy;
            $('#target').Jcrop({
                onChange: updatePreview,
                onSelect: updatePreview,
                aspectRatio: 1
            }, function () {
                // Use the API to get the real image size
                var bounds = this.getBounds();
                boundx = bounds[0];
                boundy = bounds[1];
                // Store the API in the jcrop_api variable
                jcrop_api = this;
            });
            function updatePreview(c) {
                $('#x').val(c.x);
                $('#y').val(c.y);
                $('#w').val(c.w);
                $('#h').val(c.h);
                if (parseInt(c.w) > 0) {
                    var rx = 100 / c.w;
                    var ry = 100 / c.h;

                    $('#preview').css({
                        width: Math.round(rx * boundx) + 'px',
                        height: Math.round(ry * boundy) + 'px',
                        marginLeft: '-' + Math.round(rx * c.x) + 'px',
                        marginTop: '-' + Math.round(ry * c.y) + 'px'
                    });
                }
            };
        }

        jQuery(function ($) {

            // Create variables (in this scope) to hold the API and image size
            var jcrop_api, boundx, boundy;
            $('#target').Jcrop({
                onChange: updatePreview,
                onSelect: updatePreview,
                aspectRatio: 1
            }, function () {
                // Use the API to get the real image size
                var bounds = this.getBounds();
                boundx = bounds[0];
                boundy = bounds[1];
                // Store the API in the jcrop_api variable
                jcrop_api = this;
            });

            function updatePreview(c) {
                $('#x').val(c.x);
                $('#y').val(c.y);
                $('#w').val(c.w);
                $('#h').val(c.h);
                if (parseInt(c.w) > 0) {
                    var rx = 100 / c.w;
                    var ry = 100 / c.h;

                    $('#preview').css({
                        width: Math.round(rx * boundx) + 'px',
                        height: Math.round(ry * boundy) + 'px',
                        marginLeft: '-' + Math.round(rx * c.x) + 'px',
                        marginTop: '-' + Math.round(ry * c.y) + 'px'
                    });
                }
            };
        });

    </script>

</head>

<body>
    <div id="outer">
        <div class="jcExample">
            <div class="article">
                <h1>上传头像</h1>
                <form >
                    <table>
                        <tr>
                            <td>
                                <div id='show'>
                                    <img src="" id="target" alt="Flowers" style="" />
                                </div>
                            </td>
                            <td>
                                <div style="width: 100px; height: 100px; overflow: hidden; border-style: solid; border-width: 1pt; border-color: ">
                                    <img src="" id="preview" alt="Preview" style="" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input type="file" id="file_upload" name="file_upload" />
                            </td>

                            <td>
                                <input type="submit" id="submitbtn" value="上传头像">
                            </td>
                        </tr>
                        <script type="text/javascript">
                        <?php $timestamp = time();?>
                            $(function () {
                                $('#file_upload').uploadify({
                                	'formData'     : {
                    					'timestamp' : '<?php echo $timestamp;?>',
                    					'token'     : '<?php echo md5('unique_salt' . $timestamp);?>'
                    				},
                    				'swf'      : 'js/plugins/uploadify/uploadify.swf',
                    				'uploader' : '../index.php?url=upload/UpLoadImage',
                    				'buttonText':'选择文件',
                    				'buttonClass':'',
                    				'fileSizeLimit':'1024kB' ,
                    				'fileTypeExts':'*.jpg;*.gif;*.png',
                    				'fileTypeDesc':'Web Image Files (.JPG, .GIF, .PNG)',
                    				onUploadSuccess:function(fileObj, data, response){
                    					$.post("../index.php?url=upload/ResizeImage",{filename:fileObj.name},function(result){//图片尺寸过大时自动适应
                    			  			$('#show').html("<img src="+"http://localhost:8080/GoGoTown/trunk/crm/admin/upload/"+fileObj.name+" id='target' alt='Flowers' style=''/>");
                    					    $('img').attr('src',"http://localhost:8080/GoGoTown/trunk/crm/admin/upload/"+fileObj.name);
                    					    $('#filename').val(fileObj.name);
                    					    userJcrop();
                    					});
                    				}
                                });
                            });
                        </script>
                        <input type="hidden" id="x" name="x" />
                        <input type="hidden" id="y" name="y" />
                        <input type="hidden" id="w" name="w" />
                        <input type="hidden" id="h" name="h" />
                        <input type="hidden" id="filename" name="filename" />
                    </table>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
